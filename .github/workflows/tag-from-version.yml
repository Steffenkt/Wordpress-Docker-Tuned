name: Tag from VERSION file

on:
  push:
    branches:
      - main
  workflow_dispatch:  # üëâ erm√∂glicht manuelles Starten √ºber GitHub

jobs:
  create-tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # holt alle Tags und Branches

      - name: Read and validate version from file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
  
          # Validierungsregel: erlaubt X.Y oder X.Y.Z
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "‚ùå Ung√ºltiges Versionsformat in /VERSION: $VERSION"
            echo "Version muss im Format X.Y oder X.Y.Z sein (z. B. 6.8 oder 6.8.0)"
            exit 1
          fi
  
          echo "‚úÖ Gefundene Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or update version branch
        run: |
          BRANCH_NAME="version/${{ steps.version.outputs.version }}"
          
          # Pr√ºfe ob Branch existiert
          if git show-ref --quiet refs/remotes/origin/$BRANCH_NAME; then
            echo "‚úÖ Branch $BRANCH_NAME existiert bereits"
            git checkout $BRANCH_NAME || git checkout -b $BRANCH_NAME origin/$BRANCH_NAME
          else
            echo "‚ÑπÔ∏è Erstelle neuen Branch $BRANCH_NAME"
            git checkout -b $BRANCH_NAME
          fi
          
          # Merge main in den Version-Branch
          git merge main --no-edit
          
          # Push Branch
          git push -u origin $BRANCH_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Tagging entf√§llt, da Docker Hub Branches ben√∂tigt
      # - name: Create or update tag
      #   run: |
      #     ...
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
